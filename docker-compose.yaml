version: '3.8'

services:
  postgres:
    image: postgis/postgis:15-3.3
    container_name: trash_routes_db
    environment:
      POSTGRES_DB: trash_collection
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  osrm:
    image: osrm/osrm-backend:latest
    container_name: osrm_routing
    ports:
      - "5001:5000"
    volumes:
      - ./marmara.osm.pbf:/data/marmara.osm.pbf:ro
      - osrm_data:/data
    # Fixed Command: Corrected filenames and simplified syntax
    command: >
      bash -c "
      set -e;

      if [ ! -f /data/marmara.osrm.partition ]; then
          echo '=== Step 1/3: Extracting ===';
          osrm-extract -p /opt/car.lua /data/marmara.osm.pbf;

          echo '=== Step 2/3: Partitioning ===';
          osrm-partition /data/marmara.osrm;

          echo '=== Step 3/3: Customizing ===';
          osrm-customize /data/marmara.osrm;
      fi;

      echo '=== Starting Server ===';
      osrm-routed --algorithm=MLD /data/marmara.osrm
      "
    restart: unless-stopped # Auto-restart if it crashes

volumes:
  postgres_data:
  osrm_data: